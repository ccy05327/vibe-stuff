<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Magnetic City: An Interactive Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      src="https://cdn.plot.ly/plotly-2.32.0.min.js"
      charset="utf-8"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #fdfbf7;
        color: #434242;
      }
      .tab-active {
        color: #b97a57;
        border-color: #b97a57;
      }
      .tab-inactive {
        color: #7f7f7f;
        border-color: transparent;
      }
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        height: 400px;
        max-height: 50vh;
      }
      @media (min-width: 768px) {
        .chart-container {
          height: 500px;
        }
      }
      .map-marker {
        position: absolute;
        width: 32px;
        height: 32px;
        background-color: rgba(185, 122, 87, 0.8);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border: 2px solid white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .map-marker:hover,
      .map-marker.selected {
        transform: scale(1.2);
        background-color: rgba(160, 168, 146, 1);
        z-index: 10;
      }

      /* Custom Range Slider Styling */
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #b97a57;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        cursor: pointer;
      }

      input[type="range"]::-moz-range-thumb {
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #b97a57;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        border: none;
      }

      input[type="range"]:focus {
        outline: none;
      }

      input[type="range"]:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 2px rgba(185, 122, 87, 0.5);
      }
    </style>
  </head>
  <body class="antialiased">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex justify-start mb-6">
        <a
          href="../../index.html"
          class="flex items-center text-[#B97A57] hover:text-white hover:bg-[#B97A57] transition-all duration-300 bg-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg border border-[#B97A57]"
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            ></path>
          </svg>
          Back to Portal
        </a>
      </div>
      <header class="text-center mb-10">
        <h1
          class="text-4xl md:text-5xl font-bold text-[#434242] tracking-tight"
        >
          The Magnetic City
        </h1>
        <p class="mt-3 text-lg text-[#7F7F7F] max-w-3xl mx-auto">
          An interactive exploration of the Gensler City Pulse 2025 report on
          the cities residents don't want to leave.
        </p>

        <!-- Audio Player -->
        <div class="mt-6 max-w-lg mx-auto">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center mb-3">
              <span class="text-lg mr-2">🎧</span>
              <h3 class="text-sm font-semibold text-[#434242]">
                Listen to the Report Podcast
              </h3>
            </div>
            <audio
              id="audioPlayer"
              controls
              class="w-full mb-3"
              preload="metadata"
            >
              <source src="(EN) urban_stickiness.mp3" type="audio/mpeg" />
              Your browser does not support the audio element.
            </audio>

            <!-- Speed Control -->
            <div class="flex items-center justify-between mb-2">
              <label
                for="speedControl"
                class="text-xs font-medium text-[#434242]"
                >Playback Speed:</label
              >
              <div class="flex items-center space-x-2">
                <span
                  id="speedDisplay"
                  class="text-xs text-[#7F7F7F] min-w-[2rem]"
                  >1.0x</span
                >
                <input
                  type="range"
                  id="speedControl"
                  min="0.5"
                  max="2"
                  step="0.1"
                  value="1"
                  class="w-20 h-2 bg-[#F5F0E8] rounded-lg appearance-none cursor-pointer"
                  style="
                    background: linear-gradient(
                      to right,
                      #b97a57 0%,
                      #b97a57 50%,
                      #f5f0e8 50%,
                      #f5f0e8 100%
                    );
                  "
                />
              </div>
            </div>

            <p class="text-xs text-[#7F7F7F]">
              Audio discussion of the Gensler City Pulse 2025 findings
            </p>
          </div>
        </div>
      </header>

      <nav class="mb-8 border-b border-gray-200">
        <ul
          class="flex flex-wrap -mb-px justify-center text-sm font-medium text-center"
        >
          <li class="mr-2">
            <button
              class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-active"
              data-tab="overview"
            >
              Overview
            </button>
          </li>
          <li class="mr-2">
            <button
              class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive"
              data-tab="framework"
            >
              The "Why"
            </button>
          </li>
          <li class="mr-2">
            <button
              class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive"
              data-tab="explorer"
            >
              City Explorer
            </button>
          </li>
          <li>
            <button
              class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive"
              data-tab="context"
            >
              The Big Picture
            </button>
          </li>
        </ul>
      </nav>

      <main>
        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
          <section class="bg-[#F5F0E8] p-6 rounded-2xl mb-8">
            <h2 class="text-2xl font-bold mb-3 text-[#434242]">
              What Makes a City "Sticky"?
            </h2>
            <p class="text-base text-[#434242] leading-relaxed">
              The Gensler "City Pulse 2025" report introduces a new way to
              measure urban success: **"stickiness,"** or the likelihood of
              residents to stay in their city. It moves beyond traditional
              metrics like infrastructure and economy to focus on the human
              experience. The report's core finding is that the factors that
              attract people to a city (like jobs) are different from the
              emotional connections that make them stay (like pride and
              belonging). This interactive report explores these findings,
              starting with the cities that have mastered the art of retention.
            </p>
          </section>

          <section>
            <h3 class="text-2xl font-bold text-center mb-4 text-[#434242]">
              Top 10 Most "Magnetic" Cities
            </h3>
            <p class="text-center text-[#7F7F7F] mb-6 max-w-2xl mx-auto">
              Percentage of residents who say they are "unlikely" to move away.
            </p>
            <div class="chart-container">
              <canvas id="topCitiesChart"></canvas>
            </div>
          </section>
        </div>

        <!-- Framework Tab -->
        <div id="framework" class="tab-content hidden">
          <section class="bg-[#F5F0E8] p-6 rounded-2xl mb-8">
            <h2 class="text-2xl font-bold mb-3 text-[#434242]">
              Attraction vs. Retention: The Two Forces of Urban Life
            </h2>
            <p class="text-base text-[#434242] leading-relaxed">
              The report's central thesis is the duality of urban appeal.
              Practical needs pull people in, but emotional bonds make them
              stay. Explore the key factors for each below. Click on a factor to
              learn more about its importance in the study.
            </p>
          </section>

          <div class="grid md:grid-cols-2 gap-8">
            <div class="p-6 bg-white rounded-xl shadow-sm">
              <h3 class="text-xl font-bold text-[#A0A892] mb-4">
                → Attraction Factors (The "Pull")
              </h3>
              <p class="mb-4 text-sm text-[#7F7F7F]">
                These are the pragmatic "table stakes" that make a city a viable
                place to move to.
              </p>
              <ul class="space-y-3" id="attraction-factors"></ul>
            </div>
            <div class="p-6 bg-white rounded-xl shadow-sm">
              <h3 class="text-xl font-bold text-[#B97A57] mb-4">
                ❤️ Retention Factors (The "Stickiness")
              </h3>
              <p class="mb-4 text-sm text-[#7F7F7F]">
                These are the emotional drivers that forge long-term loyalty and
                a sense of home.
              </p>
              <ul class="space-y-3" id="retention-factors"></ul>
            </div>
          </div>
          <div
            id="factor-modal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
          >
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
              <h4 id="modal-title" class="text-lg font-bold mb-2"></h4>
              <p id="modal-text" class="text-sm text-gray-700"></p>
              <button
                id="modal-close"
                class="mt-4 w-full bg-[#B97A57] text-white py-2 rounded-lg hover:bg-opacity-90 transition"
              >
                Close
              </button>
            </div>
          </div>
        </div>

        <!-- Explorer Tab -->
        <div id="explorer" class="tab-content hidden">
          <section class="bg-[#F5F0E8] p-6 rounded-2xl mb-8">
            <h2 class="text-2xl font-bold mb-3 text-[#434242]">
              Explore the Magnetic Cities
            </h2>
            <p class="text-base text-[#434242] leading-relaxed">
              Discover the top 10 "stickiest" cities on the map. Click a marker
              to reveal a detailed analysis of what makes that city a place its
              residents are proud to call home. This section combines the
              report's rankings and deep-dive analyses into one explorable tool.
            </p>
          </section>
          <div class="grid lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3">
              <div
                id="map-container"
                class="relative w-full bg-white rounded-lg shadow-sm border border-gray-200 p-4"
                style="height: 500px"
              >
                <div id="world-map" style="width: 100%; height: 100%"></div>
              </div>
            </div>
            <div
              id="city-details-container"
              class="lg:col-span-2 p-6 bg-white rounded-xl shadow-sm self-start"
            >
              <div id="city-details">
                <h3 class="text-xl font-bold text-[#434242]">
                  Select a city on the map
                </h3>
                <p class="text-[#7F7F7F] mt-2">
                  Click on a numbered marker to learn more about its unique
                  brand of urban magnetism.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Context Tab -->
        <div id="context" class="tab-content hidden">
          <section class="bg-[#F5F0E8] p-6 rounded-2xl mb-8">
            <h2 class="text-2xl font-bold mb-3 text-[#434242]">
              Context is Key: How Does "Stickiness" Compare?
            </h2>
            <p class="text-base text-[#434242] leading-relaxed">
              A city's rank depends on the questions asked. This section
              compares the Gensler "stickiness" findings with other major 2025
              livability indices. Notice how different methodologies produce
              vastly different results, highlighting that "most livable" doesn't
              always mean "most loved." Hover over a city row to see how it
              fares across all lists.
            </p>
          </section>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">City</th>
                  <th scope="col" class="px-6 py-3 text-center">
                    Gensler "Stickiness"
                  </th>
                  <th scope="col" class="px-6 py-3 text-center">
                    EIU Livability
                  </th>
                  <th scope="col" class="px-6 py-3 text-center">
                    Resonance "Best City"
                  </th>
                  <th scope="col" class="px-6 py-3 text-center">
                    Monocle Quality of Life
                  </th>
                </tr>
              </thead>
              <tbody id="comparison-table"></tbody>
            </table>
          </div>
        </div>
      </main>

      <footer class="text-center mt-12 pt-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">
          Data sourced and adapted from the Gensler Research Institute
          <a
            href="https://www.gensler.com/gri/city-pulse-2025"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[#B97A57] hover:text-[#A0A892] underline transition-colors"
          >
            "City Pulse 2025: The Magnetic City"
          </a>
          report.
        </p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Audio Speed Control
        const audioPlayer = document.getElementById("audioPlayer");
        const speedControl = document.getElementById("speedControl");
        const speedDisplay = document.getElementById("speedDisplay");

        if (audioPlayer && speedControl && speedDisplay) {
          speedControl.addEventListener("input", function () {
            const speed = parseFloat(this.value);
            audioPlayer.playbackRate = speed;
            speedDisplay.textContent = speed.toFixed(1) + "x";

            // Update slider background to show progress
            const percentage = ((speed - 0.5) / (2 - 0.5)) * 100;
            this.style.background = `linear-gradient(to right, #B97A57 0%, #B97A57 ${percentage}%, #F5F0E8 ${percentage}%, #F5F0E8 100%)`;
          });

          // Initialize slider background
          const initialPercentage = ((1 - 0.5) / (2 - 0.5)) * 100;
          speedControl.style.background = `linear-gradient(to right, #B97A57 0%, #B97A57 ${initialPercentage}%, #F5F0E8 ${initialPercentage}%, #F5F0E8 100%)`;
        }

        const topCitiesData = [
          {
            rank: 1,
            city: "Taipei",
            country: "Taiwan",
            value: 85,
            lat: 25.033,
            lon: 121.5654,
          },
          {
            rank: 2,
            city: "Seoul",
            country: "South Korea",
            value: 82,
            lat: 37.5665,
            lon: 126.978,
          },
          {
            rank: 3,
            city: "Singapore",
            country: "Singapore",
            value: 80,
            lat: 1.3521,
            lon: 103.8198,
          },
          {
            rank: 4,
            city: "Munich",
            country: "Germany",
            value: 79,
            lat: 48.1351,
            lon: 11.582,
          },
          {
            rank: 5,
            city: "Monterrey",
            country: "Mexico",
            value: 78,
            lat: 25.6866,
            lon: -100.3161,
          },
          {
            rank: 6,
            city: "Mexico City",
            country: "Mexico",
            value: 77,
            lat: 19.4326,
            lon: -99.1332,
          },
          {
            rank: 7,
            city: "London",
            country: "United Kingdom",
            value: 75,
            lat: 51.5072,
            lon: -0.1276,
          },
          {
            rank: 8,
            city: "Bogotá",
            country: "Colombia",
            value: 74,
            lat: 4.711,
            lon: -74.0721,
          },
          {
            rank: 9,
            city: "Sydney",
            country: "Australia",
            value: 73,
            lat: -33.8688,
            lon: 151.2093,
          },
          {
            rank: 10,
            city: "Shanghai",
            country: "China",
            value: 72,
            lat: 31.2304,
            lon: 121.4737,
          },
        ];

        const cityDetailsContent = {
          Taipei: {
            title: "Taipei: The Convivial City",
            text: "Taipei tops the list with an impressive 85% retention rate. Its exceptional performance stems from world-class convenient public transportation, extremely high safety levels, and vibrant street life that perfectly embodies 'not feeling bored' and 'feeling at home.' Rich food culture, diverse creative activities, and strong local identity significantly enhance residents' civic pride.",
            rank: 1,
            value: 85,
          },
          Seoul: {
            title: "Seoul: The Cultural Powerhouse",
            text: "As Korea's economic and cultural heart, Seoul seamlessly blends cutting-edge technology with deep historical heritage. From bustling shopping districts to serene ancient palaces, from world-class pop culture to exquisite traditional arts, Seoul's diverse experiences keep residents engaged while strong national and civic pride serves as a powerful unifying force.",
            rank: 2,
            value: 82,
          },
          Singapore: {
            title: "Singapore: The Garden City-State",
            text: "As a highly organized city-state renowned for safety and greenery, Singapore provides residents with exceptional quality of life and a strong sense of 'home.' The report specifically notes that as a city-state, Singapore is its citizens' 'only urban choice' domestically, which itself serves as a powerful retention factor.",
            rank: 3,
            value: 80,
          },
          Munich: {
            title: "Munich: The European Leader",
            text: "Munich ranks highest among European cities on the list. It's not only Germany's economic powerhouse but also renowned for its high-quality living environment, rich cultural activities, and proximity to nature. The perfect balance between economic vitality and leisure lifestyle creates strong resident belonging and pride.",
            rank: 4,
            value: 79,
          },
          Monterrey: {
            title: "Monterrey: The Industrial Heart",
            text: "Monterrey's inclusion demonstrates the 'rise of the Global South.' As Mexico's industrial center, it's described as a city that provides both abundant opportunities and high livability. Strong regional culture, tight community connections, and vibrant public life play crucial roles in establishing resident belonging.",
            rank: 5,
            value: 78,
          },
          "Mexico City": {
            title: "Mexico City: The Cultural Metropolis",
            text: "This Latin American megacity boasts world-class museums, rich historical heritage, and unparalleled culinary landscapes, providing residents with constant cultural nourishment that keeps them 'never bored.' Deep cultural foundations and strong national pride serve as important emotional anchors for residents choosing to stay long-term.",
            rank: 6,
            value: 77,
          },
          London: {
            title: "London: The Global Hub",
            text: "As a global financial and cultural center, London's stickiness stems from its unparalleled diversity and vitality. World-class theaters, museums, and multicultural communities make it a city that never loses its freshness. Its unique experiences create strong resident belonging and pride in being 'Londoners.'",
            rank: 7,
            value: 75,
          },
          Bogotá: {
            title: "Bogotá: The Rising Star",
            text: "Bogotá has made significant progress in recent years in urban renewal, public space development, and cultural advancement. Its innovative public transportation system, extensive citywide cycling network, and thriving arts scene have enhanced residents' quality of life and civic pride.",
            rank: 8,
            value: 74,
          },
          Sydney: {
            title: "Sydney: The Lifestyle Capital",
            text: "Sydney is famous for its iconic harbor views, pleasant climate, and relaxed outdoor lifestyle. Residents can easily switch between bustling urban life and beautiful natural scenery, and this balance greatly enhances happiness and 'feeling at home.'",
            rank: 9,
            value: 73,
          },
          Shanghai: {
            title: "Shanghai: The Economic Engine",
            text: "As China's economic center, Shanghai makes residents proud with its rapid development, efficient management, and ever-changing skyline. This city blends traditional and modern charm, providing rich and diverse life experiences. Its vitality and opportunities keep residents 'never bored' and confident about the future.",
            rank: 10,
            value: 72,
          },
        };

        const factors = {
          attraction: [
            {
              title: "Cost of living",
              text: 'Rated "very" or "extremely" important by 83% of prospective movers. It\'s the primary gatekeeper for considering a new city.',
            },
            {
              title: "Level of crime",
              text: "A close second, rated important by 81%. Personal safety is a non-negotiable prerequisite for a move.",
            },
            {
              title: "High-quality healthcare",
              text: "Rated important by 80%. Access to reliable healthcare is a foundational need for individuals and families.",
            },
            {
              title: "Job opportunities",
              text: "A primary driver, providing the financial security necessary to establish a life in a new place.",
            },
          ],
          retention: [
            {
              title: "I don't feel bored",
              text: "The #1 predictor of retention. A city that offers engaging experiences, culture, and activities creates a vibrant life.",
            },
            {
              title: "I feel at home",
              text: "This speaks to a deep sense of belonging and comfort. It transforms a city from a location into a home.",
            },
            {
              title: "I am proud of my city",
              text: "Civic pride is a powerful emotional anchor, connecting personal identity to the city's reputation and character.",
            },
            {
              title: "My city is getting better to age",
              text: "This reflects confidence in the city's future and its ability to support residents through all life stages.",
            },
            {
              title: "My sense of belonging has grown",
              text: "This shows the city is successful at integrating residents over time, deepening their roots and community ties.",
            },
          ],
        };

        const comparisonData = [
          {
            city: "Taipei",
            gensler: "1",
            eiu: "N/A",
            resonance: "N/A",
            monocle: "N/A",
          },
          {
            city: "Ho Chi Minh City",
            gensler: "2",
            eiu: "N/A",
            resonance: "N/A",
            monocle: "N/A",
          },
          {
            city: "Singapore",
            gensler: "3",
            eiu: "N/A",
            resonance: "5",
            monocle: "N/A",
          },
          {
            city: "Sydney",
            gensler: "4",
            eiu: "6",
            resonance: "12",
            monocle: "N/A",
          },
          {
            city: "Berlin",
            gensler: "5",
            eiu: "N/A",
            resonance: "11",
            monocle: "N/A",
          },
          {
            city: "London",
            gensler: "N/A",
            eiu: "N/A",
            resonance: "1",
            monocle: "N/A",
          },
          {
            city: "Paris",
            gensler: "N/A",
            eiu: "N/A",
            resonance: "3",
            monocle: "1",
          },
          {
            city: "Copenhagen",
            gensler: "N/A",
            eiu: "1",
            resonance: "N/A",
            monocle: "N/A",
          },
          {
            city: "Vienna",
            gensler: "N/A",
            eiu: "2",
            resonance: "N/A",
            monocle: "5",
          },
          {
            city: "Zurich",
            gensler: "N/A",
            eiu: "2",
            resonance: "N/A",
            monocle: "6",
          },
        ];

        const tabs = document.querySelectorAll(".nav-tab");
        const tabContents = document.querySelectorAll(".tab-content");

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((item) => {
              item.classList.remove("tab-active");
              item.classList.add("tab-inactive");
            });
            tab.classList.add("tab-active");
            tab.classList.remove("tab-inactive");

            const target = document.getElementById(tab.dataset.tab);
            tabContents.forEach((content) => content.classList.add("hidden"));
            target.classList.remove("hidden");
          });
        });

        function createTopCitiesChart() {
          const ctx = document
            .getElementById("topCitiesChart")
            .getContext("2d");
          const sortedData = [...topCitiesData].sort(
            (a, b) => a.value - b.value
          );
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: sortedData.map((d) => `${d.city}, ${d.country}`),
              datasets: [
                {
                  label: "% Unlikely to Move",
                  data: sortedData.map((d) => d.value),
                  backgroundColor: "#B97A57",
                  borderColor: "#B97A57",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: "y",
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return ` ${context.raw}%`;
                    },
                  },
                },
              },
              scales: {
                x: {
                  beginAtZero: true,
                  grid: { color: "#e5e7eb" },
                  ticks: {
                    callback: function (value) {
                      return value + "%";
                    },
                    color: "#434242",
                  },
                },
                y: {
                  grid: { display: false },
                  ticks: { color: "#434242" },
                },
              },
            },
          });
        }

        function populateFactors() {
          const attractionList = document.getElementById("attraction-factors");
          const retentionList = document.getElementById("retention-factors");

          factors.attraction.forEach((factor) => {
            const li = document.createElement("li");
            li.innerHTML = `<button data-title="${factor.title}" data-text="${factor.text}" class="factor-btn w-full text-left p-3 bg-[#F5F0E8] rounded-md hover:bg-[#A0A892] hover:text-white transition">${factor.title}</button>`;
            attractionList.appendChild(li);
          });

          factors.retention.forEach((factor) => {
            const li = document.createElement("li");
            li.innerHTML = `<button data-title="${factor.title}" data-text="${factor.text}" class="factor-btn w-full text-left p-3 bg-[#F5F0E8] rounded-md hover:bg-[#B97A57] hover:text-white transition">${factor.title}</button>`;
            retentionList.appendChild(li);
          });

          const modal = document.getElementById("factor-modal");
          const modalTitle = document.getElementById("modal-title");
          const modalText = document.getElementById("modal-text");
          const closeModalBtn = document.getElementById("modal-close");

          document.querySelectorAll(".factor-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              modalTitle.textContent = btn.dataset.title;
              modalText.textContent = btn.dataset.text;
              modal.classList.remove("hidden");
              modal.classList.add("flex");
            });
          });

          closeModalBtn.addEventListener("click", () => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.classList.add("hidden");
              modal.classList.remove("flex");
            }
          });
        }

        function createWorldMap() {
          const mapData = [
            {
              type: "scattergeo",
              lon: topCitiesData.map((c) => c.lon),
              lat: topCitiesData.map((c) => c.lat),
              text: topCitiesData.map(
                (c) => `${c.rank}. ${c.city}, ${c.country}: ${c.value}%`
              ),
              mode: "markers",
              marker: {
                size: 15,
                color: "#B97A57",
                opacity: 0.8,
                line: {
                  color: "white",
                  width: 2,
                },
              },
              hovertemplate:
                "<b>%{text}</b><br>" +
                "Click to learn more<br>" +
                "<extra></extra>",
            },
          ];

          const layout = {
            geo: {
              projection: {
                type: "natural earth",
              },
              showland: true,
              landcolor: "#F5F0E8",
              showocean: true,
              oceancolor: "#FFFFFF",
              bgcolor: "#FDFBF7",
              countrycolor: "#E5E7EB",
              showcountries: true,
              showsubunits: true,
              subunitcolor: "#E5E7EB",
            },
            margin: { l: 0, r: 0, t: 0, b: 0 },
            paper_bgcolor: "#FDFBF7",
          };

          const config = {
            responsive: true,
            displayModeBar: false,
          };

          Plotly.newPlot("world-map", mapData, layout, config);

          // Add click event listener
          document
            .getElementById("world-map")
            .on("plotly_click", function (data) {
              const pointIndex = data.points[0].pointIndex;
              const cityName = topCitiesData[pointIndex].city;
              updateCityDetails(cityName);

              // Update marker colors to show selection
              const newColors = topCitiesData.map((_, i) =>
                i === pointIndex ? "#A0A892" : "#B97A57"
              );
              const newSizes = topCitiesData.map((_, i) =>
                i === pointIndex ? 20 : 15
              );

              Plotly.restyle("world-map", {
                "marker.color": [newColors],
                "marker.size": [newSizes],
              });
            });
        }

        function populateMap() {
          createWorldMap();
        }

        function updateCityDetails(cityName) {
          const details = cityDetailsContent[cityName];
          const container = document.getElementById("city-details");
          if (details) {
            container.innerHTML = `
                <h3 class="text-2xl font-bold text-[#434242]">${details.title}</h3>
                <div class="my-3 text-lg">
                    <span class="font-semibold text-[#B97A57]">Rank ${details.rank}</span>
                    <span class="mx-2 text-gray-300">|</span>
                    <span class="font-semibold text-[#A0A892]">${details.value}% Unlikely to Move</span>
                </div>
                <p class="text-[#434242] leading-relaxed">${details.text}</p>
            `;
          }
        }

        function populateComparisonTable() {
          const tbody = document.getElementById("comparison-table");
          comparisonData.forEach((data) => {
            const row = document.createElement("tr");
            row.className =
              "bg-white border-b hover:bg-[#F5F0E8] transition-colors duration-200";
            row.innerHTML = `
                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${
                  data.city
                }</th>
                <td class="px-6 py-4 text-center font-bold text-[#B97A57]">${
                  data.gensler !== "N/A" ? data.gensler : "–"
                }</td>
                <td class="px-6 py-4 text-center">${
                  data.eiu !== "N/A" ? data.eiu : "–"
                }</td>
                <td class="px-6 py-4 text-center">${
                  data.resonance !== "N/A" ? data.resonance : "–"
                }</td>
                <td class="px-6 py-4 text-center">${
                  data.monocle !== "N/A" ? data.monocle : "–"
                }</td>
            `;
            tbody.appendChild(row);
          });
        }

        createTopCitiesChart();
        populateFactors();
        populateMap();
        populateComparisonTable();
      });
    </script>
  </body>
</html>
